#!/bin/sh
#
# Screenshot utility (X11)
#
# Usage:
#   screenshot            → select area, copy to clipboard
#   screenshot save       → select area, save + copy
#   screenshot full       → full screen, save
#   screenshot http       → select area, copy + serve over HTTP (single file)
#   screenshot http-save  → select area, save + copy + serve over HTTP
#

set -e

# --------------------------
# Config
# --------------------------
DIR="$HOME/Pictures/Screenshots"
PORT=8000

STAMP="$(date +'%Y-%m-%d_%H-%M-%S').png"
FILE="$DIR/$STAMP"
HTTP_FILE="$DIR/http.png"

mkdir -p "$DIR"

# --------------------------
# Helpers
# --------------------------
get_ip() {
	ip route get 1.1.1.1 | awk '{for(i=1;i<=NF;i++) if ($i=="src") print $(i+1)}'
}

stop_http_server() {
	pkill -f "python3 -m http.server $PORT" 2>/dev/null || true
}

serve_http() {
	notify="${1:-silent}"   # default = silent

	stop_http_server

	IP="$(get_ip)"
	URL="http://$IP:$PORT/$(basename "$HTTP_FILE")"

	cd "$DIR" || exit 1
	python3 -m http.server "$PORT" >/dev/null 2>&1 &
	disown

	# Copy image URL to clipboard (X11)
	echo "$URL" | xclip -selection clipboard

	if [ "$notify" = "notify" ]; then
		notify-send -t 6000 "Screenshot shared" "$URL"
	fi
}

# --------------------------
# Main
# --------------------------
case "$1" in
	save)
		maim -s "$FILE" || exit 1
		xclip -selection clipboard -t image/png < "$FILE"
		notify-send "Screenshot saved & copied" "$FILE"
		;;

	full)
		maim "$FILE"
		notify-send "Full screenshot saved" "$FILE"
		;;

	http)
		maim -s "$HTTP_FILE" || exit 1
		xclip -selection clipboard -t image/png < "$HTTP_FILE"
		serve_http notify
		;;

	http-save)
		maim -s "$FILE" || exit 1
		cp "$FILE" "$HTTP_FILE"
		xclip -selection clipboard -t image/png < "$FILE"
		serve_http
		notify-send "Screenshot saved & shared" "$FILE"
		;;
	*)
		if ( set -o pipefail; maim -s | xclip -selection clipboard -t image/png ); then
			notify-send -t 1500 "Screenshot copied"
		fi
		;;
esac

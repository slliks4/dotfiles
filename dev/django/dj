#!/usr/bin/env bash

# Show usage if no args
if [ $# -lt 1 ]; then
    cat <<EOF
    Usage:
    dj start <ProjectName>     # new Django project in pipenv
    dj run [port]             # runserver 0.0.0.0:<port> (default 8000)
    dj <manage.py command>    # any other manage.py command (startapp, migrate…)
EOF
exit 1
fi

CMD="$1"; shift

case "$CMD" in

  # ─── Start a new Django project in pipenv ─────────────────────────────
  start)
  if [ -z "$1" ]; then
      echo "Error: supply a project name: dj start <ProjectName>"
      exit 2
  fi
  PROJECT="$1"

    # 1) Create project folder & cd into it
    mkdir "$PROJECT" 
    cd "$PROJECT" 

    # 2) Create env file in project dir
    export PIPENV_VENV_IN_PROJECT=1
    
    # 3) Install Django in that env
    pipenv install django

    # 4) Bootstrap the project inside pipenv
    pipenv run django-admin startproject config .

    # 5) Add .gitignore
    cat > .gitignore <<EOF
# Virtual env & config
venv/
Pipfile.lock
.env

# Python cache
__pycache__/
*.pyc

# SQLite DB
db.sqlite3

# OS/editor
.DS_Store
*.swp
EOF

    # 6) Initialize Git
    git init

    echo "✓ Project '$PROJECT' created with pipenv, Django installed, and Git initialized."
    echo "To get started, run: cd $PROJECT & pipenv shell & dj run"
    ;;

  # ─── Run the development server inside pipenv ───────────────────────────
  run|runserver)
  PORT="${1:-8000}"
  echo "Starting Django dev server on 0.0.0.0:$PORT (in pipenv)…"
  python manage.py runserver "0.0.0.0:$PORT"
  ;;

  # ─── All other manage.py commands via pipenv ────────────────────────────
  *)
  # E.g. dj startapp blog → pipenv run python manage.py startapp blog
  python manage.py "$CMD" "$@"
  ;;
esac

#!/usr/bin/env bash

# Show usage if no args
if [ $# -lt 1 ]; then
    cat <<EOF
Usage:
  dj start <ProjectName>     # new Django project in pipenv
  dj run [port]             # runserver 0.0.0.0:<port> (default 8000)
  dj <manage.py command>    # any other manage.py command (startapp, migrate…)
EOF
    exit 1
fi

CMD="$1"; shift

case "$CMD" in

  # ─── Start a new Django project in pipenv ─────────────────────────────
  start)
    if [ -z "$1" ]; then
        echo "Error: supply a project name: dj start <ProjectName>"
        exit 2
    fi
    PROJECT="$1"

    mkdir "$PROJECT"
    cd "$PROJECT"

    export PIPENV_VENV_IN_PROJECT=1

    pipenv install django
    pipenv run django-admin startproject config .

    cat > .gitignore <<EOF
# Virtual env
.venv/
Pipfile.lock
.env

# Python
__pycache__/
*.pyc

# SQLite
db.sqlite3

# OS / editor
.DS_Store
*.swp
EOF

    git init

    echo "✓ Project '$PROJECT' created"
    echo "Next steps:"
    echo "  cd $PROJECT"
    echo "  dj run"
    ;;

  # ─── Run the development server ──────────────────────────────────────
  run|runserver)
    PORT="${1:-8000}"
    echo "Starting Django dev server on 0.0.0.0:$PORT"
    pipenv run python manage.py runserver "0.0.0.0:$PORT"
    ;;

  # ─── All other manage.py commands ─────────────────────────────────────
  *)
    pipenv run python manage.py "$CMD" "$@"
    ;;
esac
